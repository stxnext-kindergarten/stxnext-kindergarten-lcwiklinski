<%inherit file='base.html'/>

<%block name='js'>
    <script type="text/javascript">
        $(function() {
            var $loading = $('#loading');

            $.getJSON('/api/v1/years_and_months/', function (result) {
                var $dropdown = $('#user-id');

                $.each(result, function (index, values) {
                    $dropdown.append($('<option />', {
                        'val': values[2] + '-' + values[1],
                        'text': values[0]
                    }))
                });

                $dropdown.show();
                $loading.hide();
            });

            $('#user-id').change(function () {
                var selectedUser = $('#user-id').val(),
                    $chartDiv = $('#chart-div'),
                    date = selectedUser.replace('-', '/'),
                    $errorDiv = $('#error-msg');

                $chartDiv.hide();
                $errorDiv.hide();

                if (selectedUser) {
                    $loading.show();

                    $.getJSON('/api/v1/department/' + date, function (result) {
                        var chart,
                            data,
                            chartValues = [],
                            options = {
                                tooltip: {isHtml: true},
                                width: 750,
                                vAxis: {
                                    gridlines: {
                                        count: 6
                                    }
                                }
                            };

                        $.each(result, function (index, item) {
                            var time = formatSeconds(item[1]),
                                tooltip = [
                                    'Time: ',
                                    time,
                                    ' h',
                                    '<br />',
                                    'Employees: ',
                                    item[2]
                                ].join ('');

                            chartValues[index] = [
                                item[0], time, tooltip
                            ];
                        });
                        chartValues.unshift([
                            {type: 'string', label: 'Department'},
                            {type: 'number', label: 'Time in \n(h)', p: {html: true}},
                            {label: 'Employees', role: 'tooltip', p: {html: true}}
                        ]);

                        data = google.visualization.arrayToDataTable(chartValues);
                        chart = new google.visualization.ColumnChart($chartDiv[0]);

                        chart.draw(data, options);
                    })
                        .success(function () {
                            $chartDiv.show();
                            $loading.hide();
                        })
                        .error(function () {
                            $errorDiv.text('Something went wrong.').show();
                        })
                }
            });
        });
    </script>
</%block>

<%block name='header'>Department work time by month of the year.</%block>
